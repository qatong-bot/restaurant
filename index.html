<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½é¤å…ç‚¹é¤ç³»ç»Ÿ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f9}
header{background:#ff6b6b;color:white;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.cart-icon{position:relative;cursor:pointer;font-size:20px}
.cart-badge{position:absolute;top:-8px;right:-10px;background:#2ed573;color:white;font-size:12px;padding:2px 6px;border-radius:50%}
.category-bar{display:flex;gap:10px;padding:15px 30px;flex-wrap:wrap;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.category-btn{padding:6px 14px;border:none;border-radius:20px;background:#eee;cursor:pointer}
.category-btn.active{background:#ff6b6b;color:white}
.menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:30px;transition:margin-right 0.4s}
.card{background:white;border-radius:14px;overflow:hidden;box-shadow:0 6px 15px rgba(0,0,0,0.06);transition:.3s}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:160px;object-fit:cover}
.card-body{padding:15px}
.price{color:#ff6b6b;font-weight:bold;margin:8px 0}
.add-btn{width:100%;padding:8px;border:none;background:#ff6b6b;color:white;border-radius:8px;cursor:pointer}
.cart{position:fixed;right:-350px;top:0;width:320px;height:100%;background:white;box-shadow:-4px 0 15px rgba(0,0,0,0.1);transition:.4s;padding:20px;overflow-y:auto;z-index:200}
.cart.open{right:0}
.cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.close-cart{cursor:pointer;font-size:18px;color:#999}
.close-cart:hover{color:#ff4757}
.cart-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.qty-btn{background:#ff6b6b;border:none;color:white;width:22px;height:22px;border-radius:50%;cursor:pointer;font-size:12px}
.remove-btn{background:none;border:none;color:#ff4757;cursor:pointer;font-size:12px}
.summary-line{display:flex;justify-content:space-between;margin-top:5px}
.total{margin-top:10px;font-weight:bold;font-size:16px}
.checkout{margin-top:15px;width:100%;padding:10px;background:#2ed573;border:none;color:white;border-radius:8px;cursor:pointer}

#langSelect{padding:6px 10px;border-radius:6px;cursor:pointer;position:fixed;top:15px;right:80px;z-index:2000;}

/* å³ä¸‹è§’æ‚¬æµ®æŒ‰é’® */
.order-history-btn{position:fixed;bottom:20px;right:20px;z-index:2000;padding:8px 14px;border:none;border-radius:50px;cursor:pointer;background:#fff;color:#333;font-weight:500;box-shadow:0 2px 6px rgba(0,0,0,0.15);transition:all .2s;}
.order-history-btn:hover{background:#ff6b6b;color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2);}

/* å¼¹çª—ä½ç½®è°ƒæ•´ï¼Œé¿å…æŒ¡è´­ç‰©è½¦ */
#orderHistory{display:none;position:fixed;bottom:70px;right:20px;width:320px;height:60%;background:white;box-shadow:0 0 15px rgba(0,0,0,0.2);padding:20px;overflow-y:auto;z-index:250;border-radius:12px}
#orderHistory h2{margin-bottom:10px}
#orderHistory .close-history{cursor:pointer;float:right;color:#999;font-size:16px}
#orderHistory .order-entry{border-bottom:1px solid #ddd;margin-bottom:10px;padding-bottom:5px;font-size:14px}

@media(max-width:768px){.menu{padding:15px}.cart{width:100%}.order-history-btn{bottom:70px;right:15px}}
</style>
</head>
<body>

<select id="langSelect" onchange="setLang(this.value)">
  <option value="zh">ä¸­æ–‡</option>
  <option value="en">EN</option>
  <option value="bm">BM</option>
</select>

<button class="order-history-btn" onclick="viewOrderHistory()"><span id="orderHistoryBtnText">è®¢å•å†å²</span></button>

<header>
<h1 id="title">ğŸ½ï¸ æ™ºèƒ½é¤å…</h1>
<div class="cart-icon" onclick="toggleCart()">ğŸ›’<span class="cart-badge" id="cartCount">0</span></div>
</header>

<div class="category-bar" id="categoryBar"></div>
<div class="menu" id="menu"></div>

<div class="cart" id="cart">
<div class="cart-header">
<h2 id="cartTitle">è´­ç‰©è½¦</h2>
<span class="close-cart" onclick="closeCart()">âœ–</span>
</div>
<div id="cartItems"></div>

<div class="summary-line"><span id="labelSubtotal"></span><span id="subtotal">RM 0.00</span></div>
<div class="summary-line"><span id="labelSST"></span><span id="sst">RM 0.00</span></div>
<div class="summary-line"><span id="labelService"></span><span id="service">RM 0.00</span></div>
<div class="total summary-line"><span id="labelGrandTotal"></span><span id="grandTotal">RM 0.00</span></div>

<button class="checkout" onclick="checkout()" id="checkoutBtn">ç«‹å³ç»“ç®—</button>
</div>

<div id="orderHistory">
<h2 id="orderHistoryTitle">è®¢å•å†å²</h2>
<span class="close-history" onclick="closeOrderHistory()">âœ–</span>
<div id="historyList"></div>
</div>

<script>
// è®¾ç½®å½“å‰ç”¨æˆ·
let currentUser = "User1"; // ç™»å½•æ—¶æ›¿æ¢æˆçœŸå®ç”¨æˆ·IDæˆ–ç”¨æˆ·å
const currency="RM ",SST_RATE=0.06,SERVICE_RATE=0.10;

const dishes=[
{ name:{zh:'ç‰›æ’',en:'Steak',bm:'Bistik'}, desc:{zh:'æ¾³æ´²è¿›å£ç‰›è‚‰',en:'Imported Australian Beef',bm:'Daging Lembu Import Australia'}, price:88, category:'ä¸»é£Ÿ', img:'https://via.placeholder.com/400'},
{ name:{zh:'æŠ«è¨',en:'Pizza',bm:'Piza'}, desc:{zh:'èŠå£«æµ“éƒç°çƒ¤',en:'Cheesy Freshly Baked',bm:'Keju Sedap Baru Dibakar'}, price:58, category:'ä¸»é£Ÿ', img:'https://via.placeholder.com/400'},
{ name:{zh:'æ„é¢',en:'Pasta',bm:'Pasta'}, desc:{zh:'ç»å…¸è‚‰é…±é£å‘³',en:'Classic Meat Sauce',bm:'Rasa Sos Daging Klasik'}, price:48, category:'ä¸»é£Ÿ', img:'https://via.placeholder.com/400'},
{ name:{zh:'æ±‰å ¡',en:'Burger',bm:'Burger'}, desc:{zh:'åŒå±‚ç‰›è‚‰å ¡',en:'Double Beef Patty',bm:'Burger Daging Lapis Dua'}, price:36, category:'ä¸»é£Ÿ', img:'https://via.placeholder.com/400'},
{ name:{zh:'è–¯æ¡',en:'French Fries',bm:'Kentang Goreng'}, desc:{zh:'ç°ç‚¸é…¥è„†',en:'Crispy & Freshly Fried',bm:'Renyah & Baru Digoreng'}, price:15, category:'å°åƒ', img:'https://via.placeholder.com/400'},
{ name:{zh:'å¥¶èŒ¶',en:'Milk Tea',bm:'Teh Susu'}, desc:{zh:'é¦™æµ“é¡ºæ»‘',en:'Rich & Smooth',bm:'Penuh Rasa & Lembut'}, price:18, category:'é¥®å“', img:'https://via.placeholder.com/400'}
];

let cart=JSON.parse(localStorage.getItem("cart_" + currentUser))||[],currentCategory="å…¨éƒ¨",currentLang="zh";

const translations={
zh:{title:"ğŸ½ï¸ æ™ºèƒ½é¤å…",cart:"è´­ç‰©è½¦",add:"åŠ å…¥è´­ç‰©è½¦",checkout:"ç«‹å³ç»“ç®—",subtotal:"å°è®¡",tax:"SST 6%",service:"æœåŠ¡è´¹ 10%",grandTotal:"æ€»é‡‘é¢", remove:"åˆ é™¤", noOrders:"æš‚æ— è®¢å•", orderHistory:"è®¢å•å†å²"},
en:{title:"ğŸ½ï¸ Smart Restaurant",cart:"Cart",add:"Add to Cart",checkout:"Checkout",subtotal:"Subtotal",tax:"SST 6%",service:"Service Charge 10%",grandTotal:"Grand Total", remove:"Remove", noOrders:"No Orders", orderHistory:"Order History"},
bm:{title:"ğŸ½ï¸ Restoran Pintar",cart:"Troli",add:"Tambah",checkout:"Bayar",subtotal:"Jumlah",tax:"Cukai SST 6%",service:"Caj Perkhidmatan 10%",grandTotal:"Jumlah Keseluruhan", remove:"Buang", noOrders:"Tiada Pesanan", orderHistory:"Sejarah Pesanan"}
};

const categoryTranslations={
zh:{å…¨éƒ¨:"å…¨éƒ¨",ä¸»é£Ÿ:"ä¸»é£Ÿ",å°åƒ:"å°åƒ",é¥®å“:"é¥®å“"},
en:{å…¨éƒ¨:"All",ä¸»é£Ÿ:"Main",å°åƒ:"Side",é¥®å“:"Drink"},
bm:{å…¨éƒ¨:"Semua",ä¸»é£Ÿ:"Utama",å°åƒ:"Sampingan",é¥®å“:"Minuman"}
};

function formatMoney(num){return currency+num.toFixed(2)}
function renderCategories(){
  const bar=document.getElementById("categoryBar");
  bar.innerHTML="";
  const cats=["å…¨éƒ¨",...new Set(dishes.map(d=>d.category))];
  cats.forEach(cat=>{
    bar.innerHTML+=`<button class="category-btn ${cat===currentCategory?'active':''}" onclick="filterCategory('${cat}')">${categoryTranslations[currentLang][cat]}</button>`;
  });
}
function filterCategory(cat){currentCategory=cat;renderCategories();renderMenu()}
function renderMenu(){
  const menu=document.getElementById("menu");
  menu.innerHTML="";
  const list=currentCategory==="å…¨éƒ¨"?dishes:dishes.filter(d=>d.category===currentCategory);
  list.forEach(d=>{
    menu.innerHTML+=`<div class="card">
      <img src="${d.img}">
      <div class="card-body">
        <h3>${d.name[currentLang]}</h3>
        <p>${d.desc[currentLang]}</p>
        <p class="price">${formatMoney(d.price)}</p>
        <button class="add-btn" onclick="addToCart('${d.name.zh}')">${translations[currentLang].add}</button>
      </div>
    </div>`;
  });
}
function addToCart(nameZh){
  const item=cart.find(i=>i.nameZh===nameZh);
  if(item)item.qty++; else {const dish=dishes.find(d=>d.name.zh===nameZh);cart.push({...dish,qty:1,nameZh});}
  saveCart()
}
function changeQty(nameZh,delta){const item=cart.find(i=>i.nameZh===nameZh);if(!item) return;item.qty+=delta;if(item.qty<=0) cart=cart.filter(i=>i.nameZh!==nameZh);saveCart()}
function removeItem(nameZh){cart=cart.filter(i=>i.nameZh!==nameZh);saveCart()}
function saveCart(){localStorage.setItem("cart_" + currentUser,JSON.stringify(cart));renderCart()}
function renderCart(){
  const box=document.getElementById("cartItems");box.innerHTML="";
  let subtotal=0,count=0;
  cart.forEach(i=>{
    subtotal+=i.price*i.qty;count+=i.qty;
    box.innerHTML+=`<div class="cart-item">
      <div>${i.name[currentLang]} x${i.qty}<br>
        <button class="qty-btn" onclick="changeQty('${i.nameZh}',-1)">-</button> ${i.qty} <button class="qty-btn" onclick="changeQty('${i.nameZh}',1)">+</button>
      </div>
      <div>${formatMoney(i.price*i.qty)}<br>
        <button class="remove-btn" onclick="removeItem('${i.nameZh}')">${translations[currentLang].remove}</button>
      </div>
    </div>`;
  });
  const sst=subtotal*SST_RATE,service=subtotal*SERVICE_RATE,grand=subtotal+sst+service;
  document.getElementById("labelSubtotal").innerText=translations[currentLang].subtotal;
  document.getElementById("subtotal").innerText=formatMoney(subtotal);
  document.getElementById("labelSST").innerText=translations[currentLang].tax;
  document.getElementById("sst").innerText=formatMoney(sst);
  document.getElementById("labelService").innerText=translations[currentLang].service;
  document.getElementById("service").innerText=formatMoney(service);
  document.getElementById("labelGrandTotal").innerText=translations[currentLang].grandTotal;
  document.getElementById("grandTotal").innerText=formatMoney(grand);
  document.getElementById("cartCount").innerText=count;
}
function toggleCart(){
  const cartEl=document.getElementById("cart");
  const menuEl=document.getElementById("menu");
  const isOpen=!cartEl.classList.contains("open");
  cartEl.classList.toggle("open");
  setTimeout(()=>menuEl.style.marginRight=isOpen?"350px":"0px",10);
}
function closeCart(){document.getElementById("cart").classList.remove("open");document.getElementById("menu").style.marginRight="0px"}

// è®¢å•å†å²
function saveOrderHistory(order){
  let history = JSON.parse(localStorage.getItem("orderHistory_" + currentUser)) || [];
  history.push(order);
  localStorage.setItem("orderHistory_" + currentUser, JSON.stringify(history));
}
function closeOrderHistory(){document.getElementById("orderHistory").style.display="none"}
function setLang(lang){
  currentLang=lang;
  document.getElementById("title").innerText=translations[lang].title;
  document.getElementById("cartTitle").innerText=translations[lang].cart;
  document.getElementById("checkoutBtn").innerText=translations[lang].checkout;
  document.getElementById("orderHistoryBtnText").innerText=translations[lang].orderHistory;
  document.getElementById("orderHistoryTitle").innerText=translations[lang].orderHistory;
  renderCategories(); renderMenu(); renderCart();
  if(document.getElementById("orderHistory").style.display==="block"){viewOrderHistory();}
  document.getElementById("langSelect").value=lang;
}

(function migrateOldOrderHistory(){
  const key = "orderHistory_" + currentUser;
  let history = JSON.parse(localStorage.getItem(key)) || [];
  let changed = false;

  history = history.map(o => {
    // å¦‚æœ grandTotal å·²å­˜åœ¨ï¼Œè¯´æ˜æ˜¯æ–°æ ¼å¼ï¼Œæ— éœ€ä¿®æ”¹
    if(o.grandTotal !== undefined) return o;

    const subtotal = o.subtotal || (o.items ? o.items.reduce((sum,i)=>sum+(i.price*i.qty),0) : 0);
    const sst = subtotal * SST_RATE;
    const service = subtotal * SERVICE_RATE;
    const grandTotal = subtotal + sst + service;

    changed = true;
    return {
      time: o.time || new Date().toLocaleString(),
      items: o.items.map(i=>({
        nameZh: i.nameZh || i.name || "æœªçŸ¥èœå“",
        name: i.name || {},
        qty: i.qty || 0,
        price: i.price || 0
      })),
      subtotal,
      sst,
      service,
      grandTotal
    };
  });

  if(changed){
    localStorage.setItem(key, JSON.stringify(history));
    console.log("æ—§è®¢å•å†å²å·²è¿ç§»åˆ°æ–°æ ¼å¼ âœ…");
  }
})();
function checkout(){
  if(!cart.length){ alert("è´­ç‰©è½¦ä¸ºç©º"); return; }

  const subtotal = cart.reduce((sum,i)=>sum+i.price*i.qty,0);
  const sst = subtotal * SST_RATE;
  const service = subtotal * SERVICE_RATE;
  const grandTotal = subtotal + sst + service;

  // å­˜è®¢å•æ—¶ç›´æ¥æŠŠæ€»é¢å­˜è¿›å»
  const order = {
    time: new Date().toLocaleString(),
    items: cart.map(i=>({
      nameZh: i.nameZh,
      name: i.name,
      qty: i.qty,
      price: i.price
    })),
    subtotal,
    sst,
    service,
    grandTotal
  };

  saveOrderHistory(order);
  alert("ä¸‹å•æˆåŠŸï¼");
  cart=[]; saveCart(); toggleCart();
}

function viewOrderHistory(){
  const historyDiv = document.getElementById("orderHistory");
  const historyList = document.getElementById("historyList");
  historyList.innerHTML="";

  const history = JSON.parse(localStorage.getItem("orderHistory_" + currentUser)) || [];
  if(history.length===0){
    historyList.innerHTML=`<p>${translations[currentLang].noOrders}</p>`;
  } else {
    history.slice().reverse().forEach((o,i)=>{
      let itemsHTML = '';
      try {
        itemsHTML = o.items.map(it=>{
          const name = (it.name && it.name[currentLang]) || it.nameZh || it.name || "æœªçŸ¥èœå“";
          const qty = it.qty || 0;
          return `${name} x${qty}`;
        }).join('<br>');
      } catch(e){
        itemsHTML = "æ— æ³•æ˜¾ç¤ºèœå“";
        console.error("è®¢å•å†å²æ˜¾ç¤ºé”™è¯¯", e);
      }

      // æ˜¾ç¤º subtotal + SST + æœåŠ¡è´¹ + æ€»é¢
      let html = `<div class="order-entry">
        <strong>${translations[currentLang].orderHistory} ${history.length-i} - ${o.time || "æœªçŸ¥æ—¶é—´"}</strong><br>
        ${itemsHTML}<br>
        <em>${translations[currentLang].subtotal} + ${translations[currentLang].tax} + ${translations[currentLang].service} = ${currency}${(o.grandTotal||0).toFixed(2)}</em>
      </div>`;
      historyList.innerHTML += html;
    });
  }

  historyDiv.style.display = "block";
}
function viewOrderHistory(){
  const historyDiv = document.getElementById("orderHistory");
  const historyList = document.getElementById("historyList");
  historyList.innerHTML="";

  const history = JSON.parse(localStorage.getItem("orderHistory_" + currentUser)) || [];
  if(history.length===0){
    historyList.innerHTML=`<p>${translations[currentLang].noOrders}</p>`;
  } else {
    let totalGrand = 0; // ç´¯è®¡æ‰€æœ‰è®¢å•çš„æ€»é¢

    history.slice().reverse().forEach((o,i)=>{
      let itemsHTML = '';
      try {
        itemsHTML = o.items.map(it=>{
          const name = (it.name && it.name[currentLang]) || it.nameZh || it.name || "æœªçŸ¥èœå“";
          const qty = it.qty || 0;
          return `${name} x${qty}`;
        }).join('<br>');
      } catch(e){
        itemsHTML = "æ— æ³•æ˜¾ç¤ºèœå“";
        console.error("è®¢å•å†å²æ˜¾ç¤ºé”™è¯¯", e);
      }

      totalGrand += o.grandTotal || 0;

      let html = `<div class="order-entry">
        <strong>${translations[currentLang].orderHistory} ${history.length-i} - ${o.time || "æœªçŸ¥æ—¶é—´"}</strong><br>
        ${itemsHTML}<br>
        <em>${translations[currentLang].subtotal} + ${translations[currentLang].tax} + ${translations[currentLang].service} = ${currency}${(o.grandTotal||0).toFixed(2)}</em>
      </div>`;
      historyList.innerHTML += html;
    });

    // åœ¨æœ€åæ˜¾ç¤ºç´¯è®¡æ€»é‡‘é¢
    historyList.innerHTML += `<div class="order-entry" style="border-top:2px solid #ff6b6b; font-weight:bold; margin-top:10px; padding-top:5px;">
      ç´¯è®¡æ¶ˆè´¹æ€»é¢: ${currency}${totalGrand.toFixed(2)}
    </div>`;
  }

  historyDiv.style.display = "block";
}

// åˆå§‹åŒ–
renderCategories(); renderMenu(); renderCart();
</script>
</body>
</html>
